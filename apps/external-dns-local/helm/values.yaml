# External-DNS for Local Network with Unbound Webhook
# This deploys external-dns configured to use the Unbound webhook provider
# for automatic DNS management on your local network.

external-dns:
  # Provider configuration - use webhook for Unbound
  provider: webhook

  # Sources to watch for DNS records
  sources:
    - gateway-httproute
    - service

  # Domain filtering - only manage .local domains
  domainFilters:
    - tryy3.local  # CHANGE THIS to your local domain

  # Label filter - only process resources with this label
  labelFilter: external-dns-local==enabled

  # Registry configuration for tracking DNS records
  registry: txt
  txtOwnerId: external-dns-local
  txtPrefix: local-

  # Sync policy
  policy: sync

  # Update interval
  interval: 1m

  # Logging
  logLevel: info
  logFormat: text

  # Resource limits
  resources:
    requests:
      memory: 64Mi
      cpu: 50m
    limits:
      memory: 128Mi
      cpu: 100m

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  # ServiceAccount (should already exist from main external-dns)
  serviceAccount:
    create: false
    name: external-dns

  # RBAC
  rbac:
    create: true

  # Webhook configuration
  extraArgs:
    - --webhook-provider-url=http://localhost:8888

  # Sidecar container for Unbound webhook
  sidecars:
    - name: unbound-webhook
      image: ghcr.io/guillomep/external-dns-unbound-webhook:v0.1.3
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 8888
          name: http
          protocol: TCP
      env:
        # Unbound server configuration
        # IMPORTANT: Change these to match your Unbound server!
        - name: UNBOUND_HOST
          value: "192.168.1.3"  # ← Your Unbound server IP/hostname
        - name: UNBOUND_PORT
          value: "8953"

        # Domain filter
        - name: DOMAIN_FILTER
          value: "tryy3.local"  # ← Your local domain

        # Logging
        - name: LOG_LEVEL
          value: "info"

        # Optional: Dry run mode (set to "true" for testing)
        - name: DRY_RUN
          value: "false"

      # Optional: Mount certificates for TLS authentication with Unbound
      # Uncomment if your Unbound requires client certificates
      # volumeMounts:
      #   - name: unbound-certs
      #     mountPath: /etc/unbound-certs
      #     readOnly: true

      resources:
        requests:
          memory: 32Mi
          cpu: 25m
        limits:
          memory: 64Mi
          cpu: 50m

      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL

      # Health checks
      livenessProbe:
        httpGet:
          path: /healthz
          port: http
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5

      readinessProbe:
        httpGet:
          path: /readyz
          port: http
        initialDelaySeconds: 5
        periodSeconds: 5
        timeoutSeconds: 5

  # Optional: Additional volumes for Unbound certificates
  # Uncomment and configure if your Unbound requires client certificates
  # extraVolumes:
  #   - name: unbound-certs
  #     secret:
  #       secretName: unbound-webhook-certs
  #       optional: true

  # Deployment strategy
  deploymentStrategy:
    type: Recreate

  # Service configuration
  service:
    enabled: false  # We don't need external access

  # Metrics (optional)
  serviceMonitor:
    enabled: false  # Set to true if you have Prometheus operator

# ============================================================================
# Configuration Instructions
# ============================================================================
#
# 1. Update Unbound Server Settings:
#    - Change UNBOUND_HOST to your Unbound server IP (e.g., 192.168.1.3)
#    - Change DOMAIN_FILTER to your local domain (e.g., tryy3.local)
#    - Update domainFilters above to match
#
# 2. Ensure Unbound Remote Control is Enabled:
#    See SETUP_GUIDE.md for detailed instructions on configuring Unbound
#
# 3. (Optional) Configure TLS Certificates:
#    If your Unbound requires client certificates:
#    a. Create a secret with the certificates:
#       kubectl create secret generic unbound-webhook-certs \
#         --from-file=unbound_control.key \
#         --from-file=unbound_control.pem \
#         --from-file=unbound_server.pem \
#         -n external-dns
#    b. Uncomment the volumeMounts and extraVolumes sections above
#    c. Update the webhook image to use certificates (check webhook docs)
#
# 4. Deploy:
#    The helm chart will be automatically deployed by ArgoCD, or manually:
#    cd apps/external-dns-local/helm
#    helm dependency update
#    helm upgrade --install external-dns-local . -n external-dns
#
# 5. Verify:
#    kubectl get pods -n external-dns
#    kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns-local
#
# ============================================================================
# Testing
# ============================================================================
#
# 1. Create a test Gateway:
#    See apps/envoy/extra/local-gateway-example.yaml
#
# 2. Check DNS record creation:
#    kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns-local
#
# 3. Verify in Unbound:
#    SSH to your Unbound server:
#    sudo unbound-control list_local_data | grep tryy3.local
#
# 4. Test DNS resolution:
#    dig @your-unbound-ip service.tryy3.local
#
# ============================================================================
# Troubleshooting
# ============================================================================
#
# Webhook can't connect to Unbound:
#   - Check UNBOUND_HOST is correct
#   - Verify firewall allows port 8953 from cluster
#   - Check Unbound remote control is enabled
#   - Test: kubectl exec -it pod-name -c unbound-webhook -- nc -zv unbound-host 8953
#
# DNS records not created:
#   - Check Gateway has label: external-dns-local: enabled
#   - Check Gateway has gatewayClassName: local
#   - Check hostname matches domain filter (*.tryy3.local)
#   - Check logs: kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns-local
#
# See SETUP_GUIDE.md for more detailed troubleshooting steps.
